{% from "form_field_macros.html" import render_field, render_multifield, render_check %}
<div class="box referrals box_nopadding">
  <div class="box_title">{{ _("Referrals")}}</div>
  <div class="box_content">
  {% for referral in patient.referrals | reverse %}
    <div class="referral">

      <div class="row">
        <div class="block_4">
          sent to
          <h2 class="referral_title"><a href="{{ url_for('screener.service', service_id=referral.to_service.id) }}">{{ referral.to_service.name }}</a></h2>
        </div>
        <div class="block_4">
          from 
          <h2 class="referral_title"><a href="{{ url_for('screener.service', service_id=referral.from_app_user.service.id) }}">{{ referral.from_app_user.service.name }}</a></h2>
        </div>
        <div class="block_4 text-align-right">
          <span class="referral_status referral_{{ referral.status | lower }} pull-right">{% if referral.status == 'SENT' %} sent, waiting for response {% else %} screening result received {% endif %}</span><br>
          <p>sent on {{ referral.created.strftime('%m/%d/%Y') }}</p>
        </div>
      </div>

      <div class="referral_comments">
        <p class="referral_comment">Opened by <strong><a href="{{ url_for('screener.user', user_id=referral.from_app_user.id) }}">{{ referral.from_app_user.full_name }}</a></strong>{% if referral.notes %}: {{ referral.notes or "" }}{% else %}: No notes provided{% endif %}</p>
        {% for comment in referral.comments %}
          <p class="referral_comment"><strong>Username ({{ comment.created.strftime('%m/%d/%Y') }})</strong>: {{ comment.notes }}</p>
        {% endfor %}

        {% if referral.screening_result.eligible_yn %}
        <p class="referral_comment referall_result_{{ referral.screening_result.eligible_yn }}">{{ referral.screening_result.eligible_yn }}</p>
        {% endif %}
      </div>
      
     
      {% if referral.status != 'COMPLETED' %}

        {% if current_user.id == referral.from_app_user.service.id %}
        <form method="post">
          {{ referral_form.hidden_tag() }}

          {% if referral_form.errors %}
            <ul class="alert_list alert_error">
              {% for field_name, field_errors in referral_form.errors|dictsort if field_errors %}
                {% for error in field_errors %}
                  <li>{{ referral_form[field_name].label }}: {{ error }}</li>
                {% endfor %}
              {% endfor %}
            </ul>
          {% endif %}
          {{ referral_form.notes(placeholder="Add more information, or say what else is needed for a referral to be completed ...", class="referral_form") }}
          {{ referral_form.referral_id(type="hidden", value=referral.id) }}
          {{ referral_form.submit(class="button button_blue pull-right", value="Comment") }}

          {% if current_user.service.id == referral.to_service.id %}
          <button class="button button_green pull-right">Eligible</button>
          <button class="button button_red pull-right">Ineligible</button>
          {% endif %}
        </form>
        {% endif %}

        {% if current_user.id == referral.to_service.id %}
        <form method="post">
          {{ form.hidden_tag() }}

          {% if form.errors %}
            <ul class="alert_list alert_error">
              {% for field_name, field_errors in form.errors|dictsort if field_errors %}
                {% for error in field_errors %}
                  <li>{{ form[field_name].label }}: {{ error }}</li>
                {% endfor %}
              {% endfor %}
            </ul>
          {% endif %}

          <div class="form_row">
            <div class="field_third">
              
              <p><strong>Is {{ patient.first_name }} {{ patient.last_name }} eligible for services at {{ current_user.service.name }}?</strong></p>
              
            
            </div>

          </div>

          <div class="form_row">
            {{ form.notes(placeholder="You can comment or mark them as eligible/ineligible ...", class="referral_form") }}
          </div>

          <div class="form_row">

            {{ render_field(form.sliding_scale_id, class='field_third') }}
            {{ render_check(form.eligible_yn, class="field_third field_pad_left") }}
            {{ referral_form.referral_id(type="hidden", value=referral.id) }}
            {{ form.submit(class="field_third button button_blue pull-right", value="Submit") }}

            <!-- <button type="submit" class="button button_red">
              {{ _("Patient is not eligible for services") }}
            </button> -->
          </div>
        </form>
        {% endif %}


      {% endif %}
    </div>
  {% endfor %}
  </div>
</div>

<div class="history_results box">
  <div class="box_title">{{ _("Screening Results") }}</div>
  <div class="box_content">
  {% for result in patient.screening_results %}
    <div class="history_item history_screening {{ _('results_item_eligible') if result.eligible_yn == 'Y' else _('results_item_ineligible') }} row">
      <div class="block_2 history_date">
        <span>{{ result.created.strftime('%m/%d/%Y') }}</span>
      </div>

      <div class="block_9 history_content">
        <h2 class="history_title">
          <a href="{{ url_for('screener.service', service_id=result.service.id) }}">{{ result.service.name }}</a>
        </h2>
        <p><strong>{{ _("Eligible?") }}</strong>: {{ _("Yes") if result.eligible_yn == 'Y' else _("No") }}</p>
        <p><strong>{{ _("Sliding Scale") }}</strong>: {{ result.sliding_scale.scale_name if result.sliding_scale else _("N/A")}}</p>
        {% if result.notes %}
        <p class="history_notes"><strong>{{ _("Notes") }}</strong><br>
        {{ result.notes or "" }}</p>
        {% endif %}
      </div>
    </div>
  {% endfor %}
  </div>
</div>